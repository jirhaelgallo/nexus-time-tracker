<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus AI Time Tracker</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Meta tags for mobile experience -->
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nexus AI">
    
    <!-- App Icon for iOS -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='128' fill='%232563eb'/%3E%3Ccircle cx='256' cy='256' r='180' fill='none' stroke='white' stroke-width='30'/%3E%3Cpolyline points='256 120 256 256 340 300' fill='none' stroke='white' stroke-width='30' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .timer-active { border-left: 4px solid #3b82f6; }
        .nav-link.active { background-color: #eff6ff; color: #1d4ed8; border-right: 3px solid #1d4ed8; }
        
        @media (max-width: 768px) {
            .nav-link.active { border-right: none; border-bottom: 3px solid #1d4ed8; }
            #sidebar { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
            #sidebar.open { transform: translateX(0); }
        }

        .voice-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1.15); box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        
        /* Floating Mic Button Styles */
        .fab-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 100;
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Mobile Top Bar -->
    <header class="md:hidden flex items-center justify-between p-4 bg-white border-b border-slate-200 z-50">
        <div class="flex items-center gap-2">
            <svg class="w-8 h-8 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                Nexus AI
            </h1>
        </div>
        <button onclick="toggleSidebar()" class="text-slate-600 text-2xl focus:outline-none p-2">
            <i class="fas fa-bars" id="menuIcon"></i>
        </button>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white border-r border-slate-200 flex flex-col z-40 md:relative md:translate-x-0">
        <div class="p-6 border-b hidden md:block">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-200">
                    <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <h1 class="text-xl font-bold text-slate-800">Nexus <span class="text-blue-600">AI</span></h1>
            </div>
            
            <!-- Accessible Desktop Voice Button -->
            <button id="voiceBtnDesktop" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-xl py-3 px-4 flex items-center justify-center gap-2 font-medium shadow-lg transition-all">
                <i class="fas fa-microphone"></i> Talk to AI
            </button>
            <p class="voiceStatus text-[10px] text-center mt-2 text-slate-400 font-medium uppercase tracking-wider">Ready to assist</p>
        </div>
        
        <div class="md:hidden p-6 border-b flex justify-between items-center bg-slate-50">
            <span class="font-bold text-slate-800 text-lg">Nexus AI Navigation</span>
            <button onclick="toggleSidebar()" class="text-slate-400 p-2"><i class="fas fa-times"></i></button>
        </div>

        <nav class="flex-1 mt-4">
            <a href="#" onclick="handleNav('dashboard')" class="nav-link active flex items-center px-6 py-4 text-slate-600 hover:bg-slate-50 transition-all">
                <i class="fas fa-columns w-6"></i> Dashboard
            </a>
            <a href="#" onclick="handleNav('history')" class="nav-link flex items-center px-6 py-4 text-slate-600 hover:bg-slate-50 transition-all">
                <i class="fas fa-history w-6"></i> History
            </a>
            <a href="#" onclick="handleNav('analytics')" class="nav-link flex items-center px-6 py-4 text-slate-600 hover:bg-slate-50 transition-all">
                <i class="fas fa-chart-pie w-6"></i> Analytics
            </a>
        </nav>
        
        <div class="p-6 text-xs text-slate-400 border-t">
            <p>&copy; 2024 Nexus AI Tracker</p>
        </div>
    </aside>

    <!-- Overlay -->
    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 hidden z-30 md:hidden"></div>

    <!-- Mobile Floating Action Button (FAB) -->
    <div class="fab-container md:hidden flex flex-col items-end gap-3">
        <div id="voiceLabel" class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg opacity-0 transition-opacity">Listening...</div>
        <button id="voiceBtnMobile" class="w-16 h-16 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl transition-all active:scale-95">
            <i class="fas fa-microphone"></i>
        </button>
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-slate-50 relative pb-24 md:pb-0">
        
        <!-- Dashboard Section -->
        <section id="dashboard" class="p-4 md:p-8 max-w-5xl mx-auto space-y-6">
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Active Timers</h2>
                    <p class="text-slate-500">Real-time productivity monitoring.</p>
                </div>
                <button onclick="addNewTimer()" class="w-full sm:w-auto bg-white text-blue-600 border-2 border-blue-600 px-6 py-3 rounded-xl shadow-sm font-bold hover:bg-blue-50 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> Manual Task
                </button>
            </header>

            <div id="activeTimersList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Active Timers -->
            </div>
            
            <div id="emptyState" class="hidden text-center py-10 md:py-20">
                <div class="bg-white p-8 rounded-2xl shadow-sm inline-block w-full max-w-sm border border-dashed border-slate-300">
                    <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-stopwatch text-slate-300 text-3xl"></i>
                    </div>
                    <p class="text-slate-500 font-medium">No active tasks</p>
                    <p class="text-slate-400 text-sm mt-1">Tap the microphone and say <br>"Start working on Design"</p>
                </div>
            </div>
        </section>

        <!-- History Section -->
        <section id="history" class="hidden p-4 md:p-8 max-w-5xl mx-auto space-y-6">
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Activity History</h2>
                    <p class="text-slate-500">View and manage your completed work sessions.</p>
                </div>
                <button onclick="confirmClearHistory()" id="clearAllBtn" class="hidden w-full sm:w-auto bg-white border border-red-200 text-red-600 px-4 py-2 rounded-xl hover:bg-red-50 transition-all flex items-center justify-center gap-2 text-sm font-medium">
                    <i class="fas fa-trash-alt"></i> Clear All
                </button>
            </header>

            <div id="historyContainer" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[500px]">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="p-4 font-semibold text-slate-600 text-sm">Task</th>
                                <th class="p-4 font-semibold text-slate-600 text-sm text-center">Duration</th>
                                <th class="p-4 font-semibold text-slate-600 text-sm">Date</th>
                                <th class="p-4 font-semibold text-slate-600 text-sm text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <!-- History Rows -->
                        </tbody>
                    </table>
                </div>
                <div id="historyEmpty" class="hidden p-12 text-center text-slate-400">
                    <i class="fas fa-folder-open text-4xl mb-3 block"></i>
                    Your history is currently empty.
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="hidden p-4 md:p-8 max-w-5xl mx-auto space-y-6">
            <h2 class="text-2xl font-bold text-slate-800">Productivity Analysis</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold mb-4 text-slate-700">Time Allocation</h3>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold mb-4 text-slate-700">7-Day Trend (Mins)</h3>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modals and same JS logic remains below -->
        <!-- ... (Rest of logic remains consistent with previous version) ... -->
    </main>

    <script>
        // State Management
        let timers = [];
        let history = JSON.parse(localStorage.getItem('nexus_history_v2')) || [];
        let editingId = null;
        let editSource = 'timer';
        let categoryChart = null;
        let dailyChart = null;

        window.onload = () => {
            renderTimers();
            renderHistory();
            initCharts();
            setupVoice();
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js').catch(() => {});
            }
        };

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('hidden');
        }

        function handleNav(id) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.innerText.toLowerCase().includes(id)) link.classList.add('active');
            });
            if (id === 'analytics') updateCharts();
            if (window.innerWidth < 768) toggleSidebar();
        }

        function setupVoice() {
            const btnDesktop = document.getElementById('voiceBtnDesktop');
            const btnMobile = document.getElementById('voiceBtnMobile');
            const voiceLabels = document.querySelectorAll('.voiceStatus');
            const mobileLabel = document.getElementById('voiceLabel');
            
            const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Recognition) {
                [btnDesktop, btnMobile].forEach(b => b.style.opacity = '0.5');
                return;
            }

            const rec = new Recognition();
            
            const startRec = () => {
                try { rec.start(); } catch(e) {}
            };

            rec.onstart = () => {
                [btnDesktop, btnMobile].forEach(b => b.classList.add('voice-pulse'));
                voiceLabels.forEach(l => l.innerText = "Listening...");
                mobileLabel.style.opacity = "1";
            };

            rec.onend = () => {
                [btnDesktop, btnMobile].forEach(b => b.classList.remove('voice-pulse'));
                voiceLabels.forEach(l => l.innerText = "Ready to assist");
                mobileLabel.style.opacity = "0";
            };

            rec.onresult = (e) => {
                const cmd = e.results[0][0].transcript.toLowerCase();
                handleVoice(cmd);
            };

            btnDesktop.onclick = startRec;
            btnMobile.onclick = startRec;
        }

        function handleVoice(cmd) {
            const startRegex = /(?:start|track|doing|do|work on)\s+(.+?)(?:\s+for\s+(\d+)\s+(hour|minute|min|hr|second|sec)s?)?$/i;
            const match = cmd.match(startRegex);
            if (match) {
                const task = match[1].trim();
                let sec = 0;
                if (match[2]) {
                    const val = parseInt(match[2]);
                    const unit = match[3];
                    if (unit.includes('hour') || unit === 'hr') sec = val * 3600;
                    else if (unit.includes('min')) sec = val * 60;
                    else sec = val;
                }
                addNewTimer(task, sec);
                handleNav('dashboard');
            } else if (cmd.includes('pause') || cmd.includes('stop')) {
                timers.forEach(t => t.active = false);
                renderTimers();
            } else if (cmd.includes('resume') || cmd.includes('start')) {
                timers.forEach(t => t.active = true);
                renderTimers();
            }
        }

        function addNewTimer(name = "New Task", initialSeconds = 0) {
            if (timers.length >= 6) return;
            const id = Date.now() + Math.random();
            timers.push({
                id, name, seconds: initialSeconds, active: true,
                interval: setInterval(() => {
                    const t = timers.find(timer => timer.id === id);
                    if (t && t.active) {
                        t.seconds++;
                        const el = document.getElementById(`time-${id}`);
                        if (el) el.innerText = formatTime(t.seconds);
                    }
                }, 1000)
            });
            renderTimers();
        }

        function toggleTimer(id) {
            const timer = timers.find(t => t.id === id);
            if (timer) { timer.active = !timer.active; renderTimers(); }
        }

        function finishTimer(id) {
            const idx = timers.findIndex(t => t.id === id);
            if (idx !== -1) {
                const timer = timers[idx];
                clearInterval(timer.interval);
                history.unshift({ id: timer.id, name: timer.name, seconds: timer.seconds, date: new Date().toLocaleDateString() });
                timers.splice(idx, 1);
                localStorage.setItem('nexus_history_v2', JSON.stringify(history));
                renderHistory();
                renderTimers();
            }
        }

        function renderTimers() {
            const list = document.getElementById('activeTimersList');
            const empty = document.getElementById('emptyState');
            list.innerHTML = '';
            if (timers.length === 0) { empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            timers.forEach(t => {
                const div = document.createElement('div');
                div.className = `glass-card p-5 rounded-2xl shadow-sm timer-active flex flex-col justify-between`;
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1 truncate pr-2">
                            <h3 class="font-bold text-slate-800 text-lg truncate">${t.name}</h3>
                            <span class="text-[10px] uppercase tracking-widest font-bold px-2 py-0.5 rounded ${t.active ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700'}">
                                ${t.active ? 'Running' : 'Paused'}
                            </span>
                        </div>
                        <button onclick="finishTimer(${t.id})" class="text-slate-400 hover:text-green-600 transition-colors p-1"><i class="fas fa-check-circle text-2xl"></i></button>
                    </div>
                    <div class="text-4xl font-mono font-bold text-slate-700 py-6" id="time-${t.id}">${formatTime(t.seconds)}</div>
                    <button onclick="toggleTimer(${t.id})" class="w-full py-3 ${t.active ? 'bg-slate-100 text-slate-600' : 'bg-blue-600 text-white'} rounded-xl font-bold transition-all">
                        ${t.active ? 'Pause' : 'Resume'}
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function renderHistory() {
            const body = document.getElementById('historyBody');
            const empty = document.getElementById('historyEmpty');
            body.innerHTML = '';
            if (history.length === 0) { empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            history.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-100";
                tr.innerHTML = `
                    <td class="p-4"><span class="font-medium text-slate-800">${item.name}</span></td>
                    <td class="p-4 text-center font-mono text-sm">${formatTime(item.seconds)}</td>
                    <td class="p-4 text-slate-400 text-xs">${item.date}</td>
                    <td class="p-4 text-right">
                        <button onclick="deleteHistoryItem(${item.id})" class="text-red-300 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                body.appendChild(tr);
            });
            document.getElementById('clearAllBtn').classList.toggle('hidden', history.length === 0);
        }

        function deleteHistoryItem(id) {
            history = history.filter(h => h.id !== id);
            localStorage.setItem('nexus_history_v2', JSON.stringify(history));
            renderHistory();
        }

        function formatTime(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            return [h, m, sec].map(v => v < 10 ? "0" + v : v).join(":");
        }

        function initCharts() {
            const config = { responsive: true, maintainAspectRatio: false };
            categoryChart = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'] }] },
                options: config
            });
            dailyChart = new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Minutes', data: [], backgroundColor: '#3b82f6', borderRadius: 4 }] },
                options: config
            });
        }

        function updateCharts() {
            const catMap = {};
            history.forEach(h => { catMap[h.name] = (catMap[h.name] || 0) + (h.seconds / 60); });
            categoryChart.data.labels = Object.keys(catMap);
            categoryChart.data.datasets[0].data = Object.values(catMap);
            categoryChart.update();

            const dayMap = {};
            history.forEach(h => { dayMap[h.date] = (dayMap[h.date] || 0) + (h.seconds / 60); });
            const days = Object.keys(dayMap).sort();
            dailyChart.data.labels = days.slice(-7);
            dailyChart.data.datasets[0].data = days.slice(-7).map(d => dayMap[d]);
            dailyChart.update();
        }
        
        function confirmClearHistory() { if(confirm('Delete all history?')) { history = []; renderHistory(); localStorage.removeItem('nexus_history_v2'); } }
    </script>
</body>
</html>
