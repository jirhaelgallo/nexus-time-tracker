<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus AI Time Tracker</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Meta tags for mobile experience -->
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nexus AI">
    
    <!-- App Icon for iOS (Legacy support) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='128' fill='%232563eb'/%3E%3Ccircle cx='256' cy='256' r='180' fill='none' stroke='white' stroke-width='30'/%3E%3Cpolyline points='256 120 256 256 340 300' fill='none' stroke='white' stroke-width='30' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .timer-active { border-left: 4px solid #3b82f6; }
        .nav-link.active { background-color: #eff6ff; color: #1d4ed8; border-right: 3px solid #1d4ed8; }
        
        @media (max-width: 768px) {
            .nav-link.active { border-right: none; border-bottom: 3px solid #1d4ed8; }
            #sidebar { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
            #sidebar.open { transform: translateX(0); }
        }

        /* Rotation animation removed as requested */
        .logo-static { transform: rotate(0deg); }

        .voice-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Mobile Top Bar -->
    <header class="md:hidden flex items-center justify-between p-4 bg-white border-b border-slate-200 z-50">
        <div class="flex items-center gap-2">
            <svg class="w-8 h-8 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                Nexus AI
            </h1>
        </div>
        <button onclick="toggleSidebar()" class="text-slate-600 text-2xl focus:outline-none">
            <i class="fas fa-bars" id="menuIcon"></i>
        </button>
    </header>

    <!-- Sidebar / Drawer -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white border-r border-slate-200 flex flex-col z-40 md:relative md:translate-x-0">
        <div class="p-6 border-b hidden md:block">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-200">
                    <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <h1 class="text-xl font-bold text-slate-800">Nexus <span class="text-blue-600">AI</span></h1>
            </div>
        </div>
        
        <div class="md:hidden p-6 border-b flex justify-between items-center bg-slate-50">
            <span class="font-bold text-slate-800">Menu Navigation</span>
            <button onclick="toggleSidebar()" class="text-slate-400"><i class="fas fa-times"></i></button>
        </div>

        <nav class="flex-1 mt-4">
            <a href="#" onclick="handleNav('dashboard')" class="nav-link active flex items-center px-6 py-4 text-slate-600 hover:bg-slate-50 transition-all">
                <i class="fas fa-columns w-6"></i> Dashboard
            </a>
            <a href="#" onclick="handleNav('history')" class="nav-link flex items-center px-6 py-4 text-slate-600 hover:bg-slate-50 transition-all">
                <i class="fas fa-history w-6"></i> History
            </a>
            <a href="#" onclick="handleNav('analytics')" class="nav-link flex items-center px-6 py-4 text-slate-600 hover:bg-slate-50 transition-all">
                <i class="fas fa-chart-pie w-6"></i> Analytics
            </a>
        </nav>

        <div class="p-4 bg-slate-50 border-t">
            <button id="voiceBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-xl py-4 md:py-3 px-4 flex items-center justify-center gap-2 font-medium shadow-lg transition-all touch-manipulation">
                <i class="fas fa-microphone"></i> Talk to AI
            </button>
            <p id="voiceStatus" class="text-xs text-center mt-2 text-slate-400">"Start coding for 1 hour"</p>
        </div>
    </aside>

    <!-- Overlay -->
    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 hidden z-30 md:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-slate-50 relative pb-20 md:pb-0">
        
        <!-- Dashboard Section -->
        <section id="dashboard" class="p-4 md:p-8 max-w-5xl mx-auto space-y-6">
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Active Timers</h2>
                    <p class="text-slate-500">Track task in real-time.</p>
                </div>
                <button onclick="addNewTimer()" class="w-full sm:w-auto bg-blue-600 text-white px-6 py-3 rounded-xl shadow-md hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> New Task
                </button>
            </header>

            <div id="activeTimersList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Active Timers -->
            </div>
            
            <div id="emptyState" class="hidden text-center py-10 md:py-20">
                <div class="bg-white p-8 rounded-2xl shadow-sm inline-block w-full max-w-sm">
                    <i class="fas fa-stopwatch text-slate-200 text-6xl mb-4"></i>
                    <p class="text-slate-500">No active tasks. Say "Start working" to begin.</p>
                </div>
            </div>
        </section>

        <!-- History Section -->
        <section id="history" class="hidden p-4 md:p-8 max-w-5xl mx-auto space-y-6">
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Activity History</h2>
                    <p class="text-slate-500">Edit or remove your past recorded tasks.</p>
                </div>
                <button onclick="confirmClearHistory()" id="clearAllBtn" class="hidden w-full sm:w-auto bg-white border border-red-200 text-red-600 px-4 py-2 rounded-xl hover:bg-red-50 transition-all flex items-center justify-center gap-2 text-sm font-medium">
                    <i class="fas fa-trash-alt"></i> Clear All Records
                </button>
            </header>

            <div id="historyContainer" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[500px]">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="p-4 font-semibold text-slate-600 text-sm">Activity Name</th>
                                <th class="p-4 font-semibold text-slate-600 text-sm">Duration</th>
                                <th class="p-4 font-semibold text-slate-600 text-sm">Date</th>
                                <th class="p-4 font-semibold text-slate-600 text-sm text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <!-- History Rows -->
                        </tbody>
                    </table>
                </div>
                <div id="historyEmpty" class="hidden p-12 text-center text-slate-400">
                    <i class="fas fa-folder-open text-4xl mb-3 block"></i>
                    No tasks recorded yet.
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="hidden p-4 md:p-8 max-w-5xl mx-auto space-y-6">
            <h2 class="text-2xl font-bold text-slate-800">Visual Insights</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-semibold mb-4 text-slate-700">Distribution by Task</h3>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-semibold mb-4 text-slate-700">Daily Productivity (Minutes)</h3>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Edit Modal -->
        <div id="editModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end md:items-center justify-center p-0 md:p-4">
            <div class="bg-white rounded-t-3xl md:rounded-2xl w-full max-w-md p-6 shadow-2xl animate-slide-up md:animate-none">
                <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6 md:hidden"></div>
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-edit text-blue-600"></i> Edit Record
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Task Name</label>
                        <input type="text" id="editTaskName" class="w-full border border-slate-200 rounded-xl p-3 mt-1 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-slate-700">Hours</label>
                            <input type="number" id="editHours" min="0" class="w-full border border-slate-200 rounded-xl p-3 mt-1">
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-slate-700">Minutes</label>
                            <input type="number" id="editMins" min="0" max="59" class="w-full border border-slate-200 rounded-xl p-3 mt-1">
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row gap-3 pt-4">
                        <button onclick="closeEditModal()" class="order-2 md:order-1 flex-1 py-3 bg-slate-100 rounded-xl font-medium text-slate-600 transition-colors hover:bg-slate-200">Cancel</button>
                        <button onclick="saveEdit()" class="order-1 md:order-2 flex-1 py-3 bg-blue-600 rounded-xl font-medium text-white shadow-lg hover:bg-blue-700 transition-colors">Apply Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirm Clear Modal -->
        <div id="confirmClearModal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl text-center">
                <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-trash-alt text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold mb-2 text-slate-800">Wipe All History?</h3>
                <p class="text-slate-500 text-sm mb-6">Are you sure you want to delete all recorded history? This cannot be undone.</p>
                <div class="flex gap-3">
                    <button onclick="closeClearModal()" class="flex-1 py-3 bg-slate-100 rounded-xl font-medium text-slate-600">Cancel</button>
                    <button onclick="clearAllHistory()" class="flex-1 py-3 bg-red-600 rounded-xl font-medium text-white">Yes, Delete All</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Failed', err));
            });
        }

        // State Management
        let timers = [];
        let history = JSON.parse(localStorage.getItem('nexus_history_v2')) || [];
        let editingId = null;
        let editSource = 'timer';
        let categoryChart = null;
        let dailyChart = null;

        window.onload = () => {
            renderTimers();
            renderHistory();
            initCharts();
            setupVoice();
        };

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('hidden');
        }

        function handleNav(id) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.innerText.toLowerCase().includes(id)) link.classList.add('active');
            });

            if (id === 'analytics') updateCharts();
            if (window.innerWidth < 768) toggleSidebar();
        }

        function addNewTimer(name = "New Task", initialSeconds = 0) {
            if (timers.length >= 5) return;
            const id = Date.now() + Math.random();
            timers.push({
                id,
                name,
                seconds: initialSeconds,
                active: true,
                interval: setInterval(() => {
                    const t = timers.find(timer => timer.id === id);
                    if (t && t.active) {
                        t.seconds++;
                        const el = document.getElementById(`time-${id}`);
                        if (el) el.innerText = formatTime(t.seconds);
                    }
                }, 1000)
            });
            renderTimers();
        }

        function toggleTimer(id) {
            const timer = timers.find(t => t.id === id);
            if (timer) {
                timer.active = !timer.active;
                renderTimers();
            }
        }

        function finishTimer(id) {
            const idx = timers.findIndex(t => t.id === id);
            if (idx !== -1) {
                const timer = timers[idx];
                clearInterval(timer.interval);
                
                history.unshift({
                    id: timer.id,
                    name: timer.name,
                    seconds: timer.seconds,
                    date: new Date().toLocaleDateString(),
                    rawDate: new Date().toISOString()
                });
                
                timers.splice(idx, 1);
                saveAndRefresh();
                renderTimers();
            }
        }

        function deleteHistoryItem(id) {
            history = history.filter(item => item.id !== id);
            saveAndRefresh();
        }

        function confirmClearHistory() {
            document.getElementById('confirmClearModal').classList.remove('hidden');
        }

        function closeClearModal() {
            document.getElementById('confirmClearModal').classList.add('hidden');
        }

        function clearAllHistory() {
            history = [];
            saveAndRefresh();
            closeClearModal();
        }

        function saveAndRefresh() {
            localStorage.setItem('nexus_history_v2', JSON.stringify(history));
            renderHistory();
            if (!document.getElementById('analytics').classList.contains('hidden')) updateCharts();
        }

        function openEditModal(id, source = 'timer') {
            editingId = id;
            editSource = source;
            const item = source === 'timer' ? timers.find(t => t.id === id) : history.find(h => h.id === id);
            
            if (!item) return;

            document.getElementById('editTaskName').value = item.name;
            document.getElementById('editHours').value = Math.floor(item.seconds / 3600);
            document.getElementById('editMins').value = Math.floor((item.seconds % 3600) / 60);
            document.getElementById('editModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function saveEdit() {
            const name = document.getElementById('editTaskName').value || "Unnamed Task";
            const h = parseInt(document.getElementById('editHours').value) || 0;
            const m = parseInt(document.getElementById('editMins').value) || 0;
            const totalSec = (h * 3600) + (m * 60);

            if (editSource === 'timer') {
                const t = timers.find(timer => timer.id === editingId);
                if (t) {
                    t.name = name;
                    t.seconds = totalSec;
                    renderTimers();
                }
            } else {
                const hItem = history.find(item => item.id === editingId);
                if (hItem) {
                    hItem.name = name;
                    hItem.seconds = totalSec;
                    saveAndRefresh();
                }
            }
            closeEditModal();
        }

        function formatTime(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            return [h, m, sec].map(v => v < 10 ? "0" + v : v).join(":");
        }

        function renderTimers() {
            const list = document.getElementById('activeTimersList');
            const empty = document.getElementById('emptyState');
            list.innerHTML = '';
            
            if (timers.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            timers.forEach(t => {
                const div = document.createElement('div');
                div.className = `glass-card p-5 rounded-2xl shadow-sm timer-active flex flex-col justify-between transition-all`;
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1 truncate pr-2">
                            <h3 class="font-bold text-slate-800 text-lg truncate">${t.name}</h3>
                            <span class="text-[10px] uppercase tracking-widest font-bold px-2 py-0.5 rounded ${t.active ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700'}">
                                ${t.active ? 'Running' : 'Paused'}
                            </span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openEditModal(${t.id}, 'timer')" class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-blue-600 transition-colors"><i class="fas fa-edit"></i></button>
                            <button onclick="finishTimer(${t.id})" class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-green-600 transition-colors"><i class="fas fa-check-circle text-xl"></i></button>
                        </div>
                    </div>
                    <div class="text-4xl font-mono font-bold text-slate-700 py-6 tracking-tight" id="time-${t.id}">
                        ${formatTime(t.seconds)}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleTimer(${t.id})" class="flex-1 py-3 ${t.active ? 'bg-amber-50 text-amber-700 hover:bg-amber-100' : 'bg-blue-600 text-white hover:bg-blue-700'} rounded-xl font-semibold transition-all shadow-sm">
                            ${t.active ? '<i class="fas fa-pause mr-2"></i> Pause' : '<i class="fas fa-play mr-2"></i> Resume'}
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function renderHistory() {
            const body = document.getElementById('historyBody');
            const empty = document.getElementById('historyEmpty');
            const clearBtn = document.getElementById('clearAllBtn');
            body.innerHTML = '';
            
            if (history.length === 0) {
                empty.classList.remove('hidden');
                clearBtn.classList.add('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            clearBtn.classList.remove('hidden');

            history.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-100 hover:bg-slate-50 transition-colors group";
                tr.innerHTML = `
                    <td class="p-4">
                        <span class="font-medium text-slate-800 block truncate max-w-[150px] md:max-w-none">${item.name}</span>
                    </td>
                    <td class="p-4 text-slate-600 font-mono text-sm">${formatTime(item.seconds)}</td>
                    <td class="p-4 text-slate-400 text-xs">${item.date}</td>
                    <td class="p-4 text-right whitespace-nowrap">
                        <div class="flex justify-end gap-1">
                            <button onclick="openEditModal(${item.id}, 'history')" class="w-9 h-9 flex items-center justify-center text-blue-500 hover:bg-blue-50 rounded-lg transition-all" title="Edit task">
                                <i class="fas fa-pen text-sm"></i>
                            </button>
                            <button onclick="deleteHistoryItem(${item.id})" class="w-9 h-9 flex items-center justify-center text-red-400 hover:bg-red-50 hover:text-red-600 rounded-lg transition-all" title="Delete record">
                                <i class="fas fa-trash-alt text-sm"></i>
                            </button>
                        </div>
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        function setupVoice() {
            const btn = document.getElementById('voiceBtn');
            const status = document.getElementById('voiceStatus');
            const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!Recognition) {
                btn.disabled = true;
                status.innerText = "Voice API not available";
                return;
            }

            const rec = new Recognition();
            rec.onstart = () => {
                btn.classList.add('voice-pulse');
                status.innerText = "Listening...";
            };
            rec.onend = () => {
                btn.classList.remove('voice-pulse');
            };
            rec.onresult = (e) => {
                const cmd = e.results[0][0].transcript.toLowerCase();
                status.innerText = `AI: "${cmd}"`;
                handleVoice(cmd);
            };

            btn.onclick = () => {
                try { rec.start(); } catch(err) {}
            };
        }

        function handleVoice(cmd) {
            const startRegex = /(?:start|track|doing|do|work on)\s+(.+?)(?:\s+for\s+(\d+)\s+(hour|minute|min|hr|second|sec)s?)?$/i;
            const match = cmd.match(startRegex);

            if (match) {
                const task = match[1].trim();
                let sec = 0;
                if (match[2]) {
                    const val = parseInt(match[2]);
                    const unit = match[3];
                    if (unit.includes('hour') || unit === 'hr') sec = val * 3600;
                    else if (unit.includes('min')) sec = val * 60;
                    else sec = val;
                }
                addNewTimer(task, sec);
                handleNav('dashboard');
            } else if (cmd.includes('pause') || cmd.includes('stop')) {
                timers.forEach(t => t.active = false);
                renderTimers();
            } else if (cmd.includes('resume') || cmd.includes('start')) {
                timers.forEach(t => t.active = true);
                renderTimers();
            }
        }

        function initCharts() {
            const config = { responsive: true, maintainAspectRatio: false };
            
            categoryChart = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#0ea5e9'] }] },
                options: { ...config, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 15, font: { size: 11 } } } } }
            });

            dailyChart = new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Minutes', data: [], backgroundColor: '#3b82f6', borderRadius: 6 }] },
                options: { ...config, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function updateCharts() {
            if (history.length === 0) {
                categoryChart.data.labels = [];
                categoryChart.data.datasets[0].data = [];
                dailyChart.data.labels = [];
                dailyChart.data.datasets[0].data = [];
                categoryChart.update();
                dailyChart.update();
                return;
            }

            const catMap = {};
            history.forEach(h => {
                catMap[h.name] = (catMap[h.name] || 0) + (h.seconds / 60);
            });
            categoryChart.data.labels = Object.keys(catMap);
            categoryChart.data.datasets[0].data = Object.values(catMap);
            categoryChart.update();

            const dayMap = {};
            history.forEach(h => {
                dayMap[h.date] = (dayMap[h.date] || 0) + (h.seconds / 60);
            });
            const days = Object.keys(dayMap).sort((a,b) => new Date(a) - new Date(b));
            dailyChart.data.labels = days.slice(-7);
            dailyChart.data.datasets[0].data = days.slice(-7).map(d => dayMap[d]);
            dailyChart.update();
        }
    </script>
</body>
</html>
